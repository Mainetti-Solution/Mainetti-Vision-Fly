<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mainetti Vision: FLY</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="theme-color" content="#0b0c10">

  <style>
    :root { --bg:#0b0c10; --card:#111318; --muted:#9aa4b2; --txt:#e8edf2; --acc:#ff6a00; --bad:#ff4f4f; --ok:#3ddc97; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(180deg,#0b0c10,#0a0b0f); color:var(--txt); padding-bottom:50px; }
    
    /* HERO HEADER */
    header.hero{ padding: 44px 16px 28px; border-bottom: 1px solid #1b1f2a; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px); background: rgba(11,12,16,.85); }
    .hero-inner{ max-width: 1100px; margin: 0 auto; text-align: center; }
    .hero-title{ font-size: 44px; letter-spacing: 3px; font-weight: 800; text-transform: uppercase; color: #e8edf2; }
    .hero-line{ width: 520px; max-width: 92%; height: 3px; background: #ff6a00; margin: 14px auto 14px; border-radius: 99px; }
    .hero-sub{ font-size: 22px; letter-spacing: 2px; text-transform: lowercase; color: #9aa4b2; }
    @media (max-width: 600px){ .hero-title{ font-size: 30px; } .hero-sub{ font-size: 16px; } }

    main{ max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:14px; grid-template-columns: 1.15fr .85fr; }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }
    
    .card{ background: rgba(17,19,24,.9); border:1px solid #1b1f2a; border-radius:14px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2{ margin:0 0 10px 0; font-size:14px; text-transform:uppercase; letter-spacing:1px; color:var(--acc); }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }
    
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{ width:100%; padding:10px 10px; border-radius:10px; border:1px solid #242a38; background:#0d1017; color:var(--txt); outline:none; }
    textarea{ min-height: 72px; resize:vertical; }
    
    .pill{ display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid #242a38; border-radius:12px; background:#0d1017; transition: background .2s; }
    .pill:hover{ background:#141822; }
    .pill input{ width:auto; transform: scale(1.3); accent-color: #ff6a00; }
    .pill label{ cursor:pointer; font-size:14px; }

    .sep{ height:1px; background:#1b1f2a; margin:12px 0; }
    .btns{ display:flex; flex-wrap:wrap; gap:10px; }
    button{ border:0; border-radius:12px; padding:10px 16px; cursor:pointer; background: #1a2233; color:var(--txt); border:1px solid #26304a; font-weight:600;}
    button.primary{ background: linear-gradient(180deg,#ff6a00,#d45800); border-color:#ff6a00; color:#fff; }
    button.ok{ background: #14251f; border-color:#1f4b3c; color:#d8fff1; }
    button.danger{ background: #2a1717; border-color:#512121; color:#ffd7d7; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .status{ display:flex; gap:10px; flex-wrap:wrap; }
    .badge{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #26304a; background:#0d1017; color:var(--muted);}
    .badge.ok{ border-color:#1f4b3c; color:#bfffe9;}
    .badge.bad{ border-color:#512121; color:#ffd0d0;}

    .sigbox{ display:grid; gap:10px; margin-top:10px; padding:10px; border:1px solid #242a38; border-radius:10px; background:#14161c; }
    canvas{ width:100%; height:140px; border-radius:12px; border:1px dashed #2a3143; background:#0d1017; touch-action:none;}
    .hidden{ display:none !important; }

    #printWrap{ position: fixed; left: -10000px; top: 0; width: 794px; background: white; color: black; padding: 25px; }
    #printWrap h3{ margin:0 0 10px 0; border-bottom: 2px solid #ff6a00; padding-bottom:10px; }
    #printWrap .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:12px; }
    #printWrap .box{ border:1px solid #ddd; padding:8px; border-radius:4px; background:#f9f9f9; }
    #printWrap ul{ list-style:none; padding:0; margin:10px 0; display:grid; grid-template-columns:1fr 1fr; gap:5px; }
    #printWrap li{ border-bottom:1px solid #eee; padding:4px 0; font-size:12px; }
    #printWrap .sig-print{ margin-top:10px; border:1px solid #eee; padding:5px; }

    #toast{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0d1017; border:1px solid #ff6a00; padding:10px 20px; border-radius:999px; color:#fff; font-size:14px; opacity:0; transition:.3s; pointer-events:none; z-index:1000;}
    #toast.show{ opacity:1; }
    
    /* HISTORY LIST STYLE */
    .hist-item{ display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #222; transition:.2s; background: rgba(255,255,255,0.02); margin-bottom:4px; border-radius:8px;}
    .hist-item:hover{ background: rgba(255,106,0,.05); }
    .hist-info{ flex-grow:1; padding:12px; cursor:pointer; }
    .hist-del{ padding:12px 16px; cursor:pointer; font-size:16px; background:transparent; border:none; color:#666; transition:.2s; border-left:1px solid #222; border-radius:0 8px 8px 0;}
    .hist-del:hover{ color:#ff4f4f; background: rgba(255, 79, 79, 0.15); }
  </style>
</head>

<body>
<header class="hero">
  <div class="hero-inner">
    <div class="hero-title">MAINETTI VISION: FLY</div>
    <div class="hero-line"></div>
    <div class="hero-sub">Operational Safety System</div>
  </div>
</header>

<main>
  <section class="card">
    <h2>1) Dati Missione</h2>
    <div class="row">
      <div><label>ID Missione</label><input id="missionId" placeholder="Es: MS-2026-001" /></div>
      <div><label>Data</label><input id="date" type="date" /></div>
      <div><label>Ora</label><input id="time" type="time" /></div>
      <div><label>Localit√† / Area</label><input id="location" placeholder="Es: Cresciano, Ticino" /></div>
      <div><label>Drone / UAS</label><input id="uas" placeholder="Es: DJI Mavic 3 Cine" /></div>
      <div><label>N. Operatore (E-ID)</label><input id="opId" value="CHE2c1gu7r04ebxk" placeholder="CHE-RP-..." /></div>
      <div style="grid-column: span 2">
        <label>Operazione</label>
        <select id="opType">
          <option value="">‚Äî Seleziona ‚Äî</option>
          <option>Ispezione Tecnica</option>
          <option>Fotogrammetria / 3D</option>
          <option>Videografia Cinema</option>
          <option>Addestramento / Test</option>
          <option>SAR / Ricerca</option>
        </select>
      </div>
    </div>

    <div class="sep"></div>
    <h2>2) Compliance & Sicurezza (EASA/CH)</h2>

    <div class="pill">
      <input type="checkbox" id="docsOk">
      <label for="docsOk" style="margin:0;color:var(--txt)"><b>Documenti:</b> Assicurazione RC, Attestato A1/A3 o A2, Manuale</label>
    </div>
    <div class="pill">
      <input type="checkbox" id="eidLabel">
      <label for="eidLabel" style="margin:0;color:var(--txt)"><b>ID Operatore:</b> Etichetta e-ID presente e visibile sul drone</label>
    </div>
    <div class="pill">
      <input type="checkbox" id="airspaceOk">
      <label for="airspaceOk" style="margin:0;color:var(--txt)"><b>Spazio Aereo:</b> DABS/NOTAM verificati, Geo-Zone OK</label>
    </div>
    <div class="pill">
      <input type="checkbox" id="areaClear">
      <label for="areaClear" style="margin:0;color:var(--txt)"><b>Area:</b> Sicura, senza assembramenti, consenso privacy</label>
    </div>
    <div class="pill">
      <input type="checkbox" id="meteoOk">
      <label for="meteoOk" style="margin:0;color:var(--txt)"><b>Meteo:</b> Vento, Visibilit√†, KP Index idonei</label>
    </div>

    <div class="sep"></div>
    <div class="row">
      <div class="pill"><input type="checkbox" id="battOk"> <label for="battOk" style="margin:0;color:var(--txt)">Batterie (Celle OK)</label></div>
      <div class="pill"><input type="checkbox" id="propsOk"> <label for="propsOk" style="margin:0;color:var(--txt)">Eliche/Struttura integre</label></div>
      <div class="pill"><input type="checkbox" id="camOk"> <label for="camOk" style="margin:0;color:var(--txt)">Payload/SD/Lenti OK</label></div>
      <div class="pill"><input type="checkbox" id="fwOk"> <label for="fwOk" style="margin:0;color:var(--txt)">App/Firmware (No Errori)</label></div>
      <div class="pill"><input type="checkbox" id="gnssOk"> <label for="gnssOk" style="margin:0;color:var(--txt)">Home Point + <b>RTH Height</b> OK</label></div>
    </div>

    <div class="sep"></div>
    <div class="row">
      <div>
        <label>GO / NO-GO</label>
        <select id="go">
          <option value="">‚Äî</option>
          <option value="GO">üü¢ GO - Procedere</option>
          <option value="NO-GO">üî¥ NO-GO - Abortire</option>
        </select>
      </div>
      <div><label>Mitigazione Rischi / Note</label><input id="actions" placeholder="Azioni correttive intraprese..." /></div>
    </div>
    
    <div class="sep"></div>
    <h2>3) Note Missione</h2>
    <textarea id="notes" placeholder="Dettagli operativi, contatti utili, note meteo specifiche..."></textarea>

    <div class="sep"></div>
    <div class="btns">
      <button class="ok" id="saveDraft">Salva Bozza</button>
      <button class="danger" id="reset">Nuovo Modulo</button>
    </div>
  </section>

  <aside class="card">
    <h2>Validazione & Autorizzazioni</h2>
    <div class="status">
      <div class="badge" id="bDraft">Bozza</div>
      <div class="badge bad" id="bSigned">Non firmata</div>
    </div>

    <div class="sep"></div>
    <h3>Pilota / Operatore</h3>
    <div class="row">
      <div><label>Nome Pilota</label><input id="opName" placeholder="Tuo Nome" /></div>
      <div>
        <label>Tipo Firma</label>
        <select id="opSigType" onchange="toggleSig('op')">
          <option value="draw">Disegnata</option>
          <option value="typed">Digitata</option>
        </select>
      </div>
    </div>
    <div class="sigbox" id="opSigDrawBox">
      <canvas id="opCanvas"></canvas>
      <button onclick="clearCanvas('opCanvas')" style="padding:4px 10px; font-size:11px;">Pulisci</button>
    </div>
    <div class="sigbox hidden" id="opSigTypedBox">
      <input id="opTyped" placeholder="Scrivi firma..." />
    </div>

    <div class="sep"></div>
    <div class="pill">
      <input type="checkbox" id="decl" />
      <label for="decl" style="margin:0;color:var(--txt);font-size:11px;line-height:1.3">Dichiaro di aver verificato le condizioni e di operare in conformit√† alle norme (EASA/CH).</label>
    </div>

    <div class="sep"></div>
    <div class="pill">
      <input type="checkbox" id="needManager" onchange="toggleBlock('mgrBlock', this.checked)">
      <label for="needManager" style="margin:0;color:var(--txt)">Missione soggetta a Responsabile</label>
    </div>
    <div id="mgrBlock" class="hidden" style="margin-top:10px">
      <div class="row">
        <div><label>Nome Responsabile</label><input id="mgrName" placeholder="Nome Cognome" /></div>
        <div>
          <label>Firma</label>
          <select id="mgrSigType" onchange="toggleSig('mgr')">
            <option value="draw">Disegnata</option>
            <option value="typed">Digitata</option>
          </select>
        </div>
      </div>
      <div class="sigbox" id="mgrSigDrawBox">
        <canvas id="mgrCanvas"></canvas>
        <button onclick="clearCanvas('mgrCanvas')" style="padding:4px 10px; font-size:11px;">Pulisci</button>
      </div>
      <div class="sigbox hidden" id="mgrSigTypedBox">
        <input id="mgrTyped" placeholder="Firma responsabile..." />
      </div>
    </div>

    <div class="sep"></div>
    <div class="pill">
      <input type="checkbox" id="needOwner" onchange="toggleBlock('ownerBlock', this.checked)">
      <label for="needOwner" style="margin:0;color:var(--txt)">Autorizzazione Proprietario Terreno</label>
    </div>
    <div id="ownerBlock" class="hidden" style="margin-top:10px">
      <div class="row">
        <div><label>Nome Proprietario</label><input id="ownerName" placeholder="Nome Cognome" /></div>
        <div>
          <label>Firma</label>
          <select id="ownerSigType" onchange="toggleSig('owner')">
            <option value="draw">Disegnata</option>
            <option value="typed">Digitata</option>
          </select>
        </div>
      </div>
      <div class="sigbox" id="ownerSigDrawBox">
        <canvas id="ownerCanvas"></canvas>
        <button onclick="clearCanvas('ownerCanvas')" style="padding:4px 10px; font-size:11px;">Pulisci</button>
      </div>
      <div class="sigbox hidden" id="ownerSigTypedBox">
        <input id="ownerTyped" placeholder="Firma proprietario..." />
      </div>
    </div>

    <div class="sep"></div>
    <div class="btns">
      <button class="primary" id="finalize" style="width:100%">‚úÖ Conferma e Firma Tutto</button>
      <button id="pdf" disabled style="width:100%">üìÑ Scarica PDF</button>
    </div>

    <div class="sep"></div>
    <h2>Archivio Locale</h2>
    <div class="btns">
      <button id="export">Export JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="importBtn">Import JSON</button>
    </div>
    
    <div id="history" class="mini" style="margin-top:10px;"></div>
    
    <div class="sep"></div>
    <button id="hardReset" class="danger" style="width:100%; border:1px solid red; color:#ffbaba;">‚ö†Ô∏è SALVA TUTTO & RESETTA (Fix Problemi)</button>

    <button id="exitView" class="danger hidden" style="margin-top:10px;width:100%">Chiudi Visualizzazione</button>
  </aside>
</main>

<div id="printWrap">
  <h3>MAINETTI VISION: FLY - Pre-Flight Check</h3>
  <div class="grid">
    <div class="box"><b>ID:</b> <span id="p_id"></span></div>
    <div class="box"><b>Data:</b> <span id="p_dt"></span></div>
    <div class="box"><b>Loc:</b> <span id="p_loc"></span></div>
    <div class="box"><b>UAS:</b> <span id="p_uas"></span></div>
    <div class="box"><b>Op. ID:</b> <span id="p_opId"></span></div>
  </div>
  <div style="margin-top:10px"><b>Esito:</b> <span id="p_go" style="font-weight:bold"></span></div>
  
  <h4>Checklist Compliance</h4>
  <ul id="p_checks"></ul>

  <h4>Note & Mitigazioni</h4>
  <div class="box" id="p_notes"></div>

  <h4>Firme</h4>
  
  <div class="box sig-print">
    <div><b>Pilota:</b> <span id="p_op_name"></span></div>
    <div id="p_op_sig"></div>
    <div style="font-size:9px">Data: <span id="p_sign_dt"></span></div>
  </div>

  <div id="p_mgr_section" class="box sig-print hidden" style="background:#f0f4ff; border-color:#d0d7de">
    <div><b>Responsabile Missione:</b> <span id="p_mgr_name"></span></div>
    <div id="p_mgr_sig"></div>
  </div>

  <div id="p_owner_section" class="box sig-print hidden" style="background:#f0fff4; border-color:#bceac8">
    <div><b>Autorizzazione Proprietario:</b> <span id="p_owner_name"></span></div>
    <div style="font-size:10px;margin-bottom:4px"><i>Autorizzo il sorvolo/decollo nell'area di mia propriet√†.</i></div>
    <div id="p_owner_sig"></div>
  </div>

  <div style="font-size:9px; color:#999; margin-top:20px; text-align:center">Documento generato da Mainetti Vision App</div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // --- PWA SERVICE WORKER REGISTRATION ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>console.log("SW fail"));
    });
  }

  // --- APP LOGIC ---
  const STORAGE_KEY = "ms_fly_v2_data";
  const $ = (id) => document.getElementById(id);
  const toast = (msg) => {
    const t = $("toast"); t.textContent = msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2000);
  };
  function nowISO(){ return new Date().toISOString(); }
  function uid(){ return 'ms_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
  function loadAll(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch{ return []; } }
  function saveAll(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

  // --- CANVAS MANAGER ---
  const pads = {};

  function initPad(id){
    const c = $(id);
    const ctx = c.getContext("2d");
    let drawing = false;

    // FIX 2.9: Image persistence
    let storedImage = null;

    function resize(){
      const r = c.getBoundingClientRect();
      if(r.width === 0) return; // Hidden elements have 0 width
      c.width = r.width; c.height = r.height;
      ctx.lineWidth = 2; ctx.strokeStyle = "#e8edf2";
      
      // FIX 2.9: Redraw stored image if exists
      if(storedImage){
        ctx.drawImage(storedImage, 0, 0, c.width, c.height);
      }
    }
    // Listen for window resize
    window.addEventListener("resize", resize);
    
    function getPos(e){
      const r = c.getBoundingClientRect();
      const t = e.touches ? e.touches[0] : e;
      return { x: t.clientX - r.left, y: t.clientY - r.top };
    }
    
    c.addEventListener("mousedown", e => { drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    c.addEventListener("mousemove", e => { if(drawing){ const p=getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }});
    window.addEventListener("mouseup", () => drawing=false);
    
    c.addEventListener("touchstart", e => { e.preventDefault(); drawing=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); }, {passive:false});
    c.addEventListener("touchmove", e => { if(drawing){ e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }}, {passive:false});

    // Store the resize function so we can call it later
    pads[id] = { 
      canvas: c, 
      ctx: ctx, 
      resize: resize,
      setImg: (img) => { storedImage = img; resize(); },
      clearImg: () => { storedImage = null; },
      isEmpty: () => {
        const px = ctx.getImageData(0,0,c.width,c.height).data;
        return !px.some(x=>x!==0);
      }
    };
    
    // Initial resize attempt
    setTimeout(resize, 500);
  }

  // Init all 3 pads
  initPad("opCanvas");
  initPad("mgrCanvas");
  initPad("ownerCanvas");

  window.clearCanvas = (id) => {
    const p = pads[id];
    p.clearImg(); // Fix 2.9: Clear memory
    p.ctx.clearRect(0,0,p.canvas.width,p.canvas.height);
  };

  window.drawFromUrl = (id, url) => {
    if(!url) return;
    const p = pads[id];
    p.resize();
    const img = new Image();
    img.onload = () => {
      p.setImg(img); // Fix 2.9: Store memory
    };
    img.src = url;
  };

  // FIX: Force resize when block is shown
  window.toggleBlock = (id, show) => {
    const el = $(id);
    if(el) {
        el.classList.toggle("hidden", !show);
        if(show){
            // Find canvas inside this block and resize it
            const cvs = el.querySelector("canvas");
            if(cvs && pads[cvs.id]) {
                setTimeout(() => pads[cvs.id].resize(), 50); // Small delay for rendering
            }
        }
    }
  };

  window.toggleSig = (prefix) => {
    const val = $(prefix+"SigType").value;
    $(prefix+"SigDrawBox").classList.toggle("hidden", val !== "draw");
    $(prefix+"SigTypedBox").classList.toggle("hidden", val !== "typed");
    
    // FIX: Force resize if switching to draw
    if(val === "draw"){
        const cvsId = prefix+"Canvas";
        if(pads[cvsId]) setTimeout(() => pads[cvsId].resize(), 50);
    }
  };

  // --- DATA HANDLING ---

  function getSigData(prefix){
    const type = $(prefix+"SigType").value;
    if(type === "draw"){
      return { type:"draw", val: pads[prefix+"Canvas"].canvas.toDataURL(), empty: pads[prefix+"Canvas"].isEmpty() };
    } else {
      const txt = $(prefix+"Typed").value;
      return { type:"typed", val: txt, empty: !txt };
    }
  }

  function getData(){
    return {
      mission: {
        id: $("missionId").value,
        date: $("date").value,
        time: $("time").value,
        loc: $("location").value,
        uas: $("uas").value,
        opId: $("opId").value, // NEW 3.0
        type: $("opType").value
      },
      checks: {
        docs: $("docsOk").checked,
        eid: $("eidLabel").checked, // NEW 3.0
        airspace: $("airspaceOk").checked,
        area: $("areaClear").checked,
        meteo: $("meteoOk").checked,
        batt: $("battOk").checked,
        props: $("propsOk").checked,
        cam: $("camOk").checked,
        fw: $("fwOk").checked,
        gnss: $("gnssOk").checked
      },
      outcome: {
        go: $("go").value,
        notes: $("notes").value,
        actions: $("actions").value
      },
      extra: {
        needManager: $("needManager").checked,
        mgrName: $("mgrName").value,
        needOwner: $("needOwner").checked,
        ownerName: $("ownerName").value
      }
    };
  }

  function validate(){
    const d = getData();
    if(!d.mission.date || !d.mission.loc || !d.mission.uas) return "Compila Data, Luogo e Drone.";
    if(!d.outcome.go) return "Definisci esito GO/NO-GO.";
    if(!$("opName").value) return "Nome pilota mancante.";
    if(!$("decl").checked) return "Accetta la dichiarazione.";
    
    // Check main signature
    const opSig = getSigData("op");
    if(opSig.empty) return "Firma pilota mancante.";

    // Check manager if needed
    if(d.extra.needManager){
      if(!d.extra.mgrName) return "Nome Responsabile mancante.";
      if(getSigData("mgr").empty) return "Firma Responsabile mancante.";
    }

    // Check owner if needed
    if(d.extra.needOwner){
      if(!d.extra.ownerName) return "Nome Proprietario mancante.";
      if(getSigData("owner").empty) return "Firma Proprietario mancante.";
    }

    return null;
  }

  // Save / Load
  let currentId = null; 
  
  $("saveDraft").onclick = () => {
    const all = loadAll();
    const id = currentId || uid();
    const rec = { id, status: "draft", timestamp: nowISO(), data: getData(), signatures: {} };
    const idx = all.findIndex(x=>x.id===id);
    if(idx>=0) all[idx] = rec; else all.unshift(rec);
    saveAll(all);
    currentId = id;
    renderHistory();
    toast("Bozza salvata");
  };

  $("finalize").onclick = () => {
    const err = validate();
    if(err){ toast(err); return; }
    
    const d = getData();
    const all = loadAll();
    const id = currentId || uid();
    
    // Collect signatures
    const sigs = {
      op: { name: $("opName").value, ...getSigData("op"), date: nowISO() },
      mgr: d.extra.needManager ? { name: d.extra.mgrName, ...getSigData("mgr") } : null,
      owner: d.extra.needOwner ? { name: d.extra.ownerName, ...getSigData("owner") } : null
    };

    const rec = { 
      id, status: "signed", timestamp: nowISO(), 
      data: d, signatures: sigs 
    };
    
    const idx = all.findIndex(x=>x.id===id);
    if(idx>=0) all[idx] = rec; else all.unshift(rec);
    saveAll(all);
    currentId = id;
    
    $("pdf").disabled = false;
    $("bSigned").classList.add("ok"); $("bSigned").classList.remove("bad"); $("bSigned").textContent="Firmata";
    renderHistory();
    toast("Checklist Firmata e Chiusa!");
  };

  // --- SAFE WIPE / AUTO BACKUP ---
  $("hardReset").onclick = () => {
    if(!confirm("‚ö†Ô∏è ATTENZIONE: Questo canceller√† tutti i dati dall'APP per risolvere eventuali problemi.\n\nVerr√† scaricato un backup automatico prima di procedere. Confermi?")) return;

    const all = loadAll();
    if(all.length > 0){
        const blob = new Blob([JSON.stringify(all, null, 2)], {type : 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `AUTO_BACKUP_MS_FLY_${nowISO().split('T')[0]}.json`;
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a);
        
        alert("Backup salvato. Procedo con il reset.");
    }

    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  // --- DELETE SINGLE ITEM ---
  window.deleteRec = (id, event) => {
    event.stopPropagation(); // Stop clicking row
    if(!confirm("Sei sicuro di voler eliminare questa checklist definitivamente?")) return;
    
    const all = loadAll();
    const newAll = all.filter(x => x.id !== id);
    saveAll(newAll);
    renderHistory();
    toast("Checklist eliminata üóëÔ∏è");
  }

  // --- EXPORT / IMPORT LOGIC ---
  $("export").onclick = () => {
    const all = loadAll();
    if(!all.length){ toast("Nessun dato da esportare"); return; }
    
    const blob = new Blob([JSON.stringify(all, null, 2)], {type : 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup_ms_fly_${nowISO().split('T')[0]}.json`;
    a.click();
    toast("Backup scaricato");
  };

  $("importBtn").onclick = () => $("importFile").click();
  
  $("importFile").onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    
    const r = new FileReader();
    r.onload = (ev) => {
      try {
        const imp = JSON.parse(ev.target.result);
        if(!Array.isArray(imp)) throw new Error("Formato errato");
        
        const cur = loadAll();
        imp.forEach(item => {
          const idx = cur.findIndex(x => x.id === item.id);
          if(idx === -1){
            cur.push(item);
          } else {
            if (item.timestamp > cur[idx].timestamp) {
               cur[idx] = item;
            }
          }
        });
        
        saveAll(cur);
        renderHistory();
        toast("Importazione completata!");
      } catch(err){
        console.error(err);
        toast("Errore nel file JSON");
      }
    };
    r.readAsText(f);
    e.target.value = "";
  };

  function renderSigHTML(sigObj){
    if(!sigObj) return "";
    if(sigObj.type === "draw") return `<img src="${sigObj.val}" style="max-height:50px;border-bottom:1px solid #000"/>`;
    return `<div style="font-family:serif;font-style:italic;font-size:16px">${sigObj.val}</div>`;
  }

  // --- PDF GENERATION ---
  $("pdf").onclick = () => {
    const all = loadAll();
    const rec = all.find(x=>x.id===currentId);
    if(!rec) return;

    // Populate Print Area
    $("p_id").textContent = rec.id;
    $("p_dt").textContent = rec.data.mission.date + " " + rec.data.mission.time;
    $("p_loc").textContent = rec.data.mission.loc;
    $("p_uas").textContent = rec.data.mission.uas;
    $("p_opId").textContent = rec.data.mission.opId || "-"; // NEW 3.0
    $("p_go").textContent = rec.data.outcome.go;
    $("p_notes").textContent = (rec.data.outcome.actions ? "Azioni: "+rec.data.outcome.actions+". " : "") + rec.data.outcome.notes;
    
    const labels = {
      docs: "Documenti", 
      eid: "Etichetta UAS", // NEW 3.0
      airspace: "Spazio Aereo", area: "Area Sicura",
      meteo: "Meteo", batt: "Batterie", props: "Eliche",
      cam: "Payload", fw: "Firmware", gnss: "GNSS/RTH"
    };
    $("p_checks").innerHTML = Object.keys(rec.data.checks).map(k => 
      `<li>${labels[k]}: <b>${rec.data.checks[k]?"SI":"NO"}</b></li>`
    ).join("");

    // Signatures Print
    $("p_op_name").textContent = rec.signatures.op.name;
    $("p_sign_dt").textContent = rec.signatures.op.date;
    $("p_op_sig").innerHTML = renderSigHTML(rec.signatures.op);

    const mgr = rec.signatures.mgr;
    if(mgr){
      $("p_mgr_section").classList.remove("hidden");
      $("p_mgr_name").textContent = mgr.name;
      $("p_mgr_sig").innerHTML = renderSigHTML(mgr);
    } else {
      $("p_mgr_section").classList.add("hidden");
    }

    const own = rec.signatures.owner;
    if(own){
      $("p_owner_section").classList.remove("hidden");
      $("p_owner_name").textContent = own.name;
      $("p_owner_sig").innerHTML = renderSigHTML(own);
    } else {
      $("p_owner_section").classList.add("hidden");
    }

    // Gen PDF
    const el = $("printWrap");
    html2canvas(el, {scale:2}).then(c => {
      const img = c.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const w = pdf.internal.pageSize.getWidth();
      const h = (c.height * w) / c.width;
      pdf.addImage(img, 'PNG', 0, 0, w, h);
      pdf.save(`Checklist_${rec.id}.pdf`);
    });
  };

  // --- HISTORY & LOADING ---

  function renderHistory(){
    const all = loadAll();
    all.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

    $("history").innerHTML = all.slice(0,5).map(r => `
      <div class="hist-item">
        <div class="hist-info" onclick="loadRec('${r.id}')">
          <div style="font-weight:bold">${(r.data && r.data.mission && r.data.mission.loc) ? r.data.mission.loc : "N/D"}</div>
          <div style="font-size:11px;color:#888">${(r.data && r.data.mission) ? r.data.mission.date : "?"} - ${r.status.toUpperCase()}</div>
        </div>
        <button class="hist-del" onclick="deleteRec('${r.id}', event)">üóëÔ∏è</button>
      </div>
    `).join("");
  }
  
  window.loadRec = (id) => {
    try {
      const r = loadAll().find(x=>x.id===id);
      if(!r) return;
      currentId = r.id;
      
      const d = r.data || {}; 
      const m = d.mission || {};
      $("missionId").value = m.id || "";
      $("date").value = m.date || "";
      $("time").value = m.time || "";
      $("location").value = m.loc || "";
      $("uas").value = m.uas || "";
      $("opId").value = m.opId || "CHE-RP-tf2s8sv9yo41"; // Default 3.0
      $("opType").value = m.type || "";
      
      const c = d.checks || {};
      $("docsOk").checked = !!c.docs;
      $("eidLabel").checked = !!c.eid; // NEW 3.0
      $("airspaceOk").checked = !!c.airspace;
      $("areaClear").checked = !!(c.area || c.areaClear); 
      $("meteoOk").checked = !!c.meteo;
      $("battOk").checked = !!c.batt;
      $("propsOk").checked = !!c.props;
      $("camOk").checked = !!c.cam;
      $("fwOk").checked = !!c.fw;
      $("gnssOk").checked = !!c.gnss;

      const out = d.outcome || {};
      $("go").value = out.go || "";
      $("actions").value = out.actions || "";
      $("notes").value = out.notes || "";

      const ext = d.extra || {};
      clearCanvas("opCanvas"); clearCanvas("mgrCanvas"); clearCanvas("ownerCanvas");

      $("needManager").checked = !!ext.needManager;
      toggleBlock("mgrBlock", !!ext.needManager);
      $("mgrName").value = ext.mgrName || "";

      $("needOwner").checked = !!ext.needOwner;
      toggleBlock("ownerBlock", !!ext.needOwner);
      $("ownerName").value = ext.ownerName || "";

      if(r.status === "signed" && r.signatures){
        const op = r.signatures.op || {};
        $("opName").value = op.name || "";
        if(op.type){
            $("opSigType").value = op.type;
            toggleSig("op");
            if(op.type === "draw") drawFromUrl("opCanvas", op.val);
            else $("opTyped").value = op.val;
        }

        if(r.signatures.mgr){
          const mgr = r.signatures.mgr;
          $("mgrSigType").value = mgr.type;
          toggleSig("mgr");
          if(mgr.type === "draw") drawFromUrl("mgrCanvas", mgr.val);
          else $("mgrTyped").value = mgr.val;
        }

        if(r.signatures.owner){
          const own = r.signatures.owner;
          $("ownerSigType").value = own.type;
          toggleSig("owner");
          if(own.type === "draw") drawFromUrl("ownerCanvas", own.val);
          else $("ownerTyped").value = own.val;
        }

        $("pdf").disabled = false;
        $("bSigned").textContent = "Firmata";
        $("bSigned").classList.add("ok");
        document.querySelectorAll("input, select, textarea").forEach(i => i.disabled=true);
        $("exitView").classList.remove("hidden");

      } else {
        $("pdf").disabled = true;
        $("bSigned").textContent = "Non firmata";
        $("bSigned").classList.remove("ok");
        document.querySelectorAll("input, select, textarea").forEach(i => i.disabled=false);
        $("exitView").classList.add("hidden");
      }
      toast("Dati caricati!");
    } catch(e) {
      console.error(e);
      toast("Errore (Prova Reset Dati)");
    }
  };

  $("exitView").onclick = () => location.reload();
  $("reset").onclick = () => location.reload();

  (function init(){
    $("date").value = new Date().toISOString().split("T")[0];
    renderHistory();
  })();
</script>
</body>
</html>